<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FixZen â€” Secure Auth</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
    .fade { animation: fadeIn .35s ease-out; }
    @keyframes fadeIn { from {opacity:0} to {opacity:1} }
    @keyframes slowRotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    /* Loading Spinner */
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #0d9488; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>

<body class="relative min-h-screen bg-slate-100 dark:bg-slate-900 transition-all duration-300 font-sans">

<div class="pointer-events-none fixed inset-0 flex justify-center items-center opacity-5">
  <img src="https://cdn-icons-png.flaticon.com/512/10309/10309221.png"
       class="w-[500px] h-[500px] blur-2xl select-none animate-[slowRotate_60s_linear_infinite]">
</div>

<div class="min-h-screen flex flex-col justify-center items-center px-4 relative z-10">

  <div class="mb-6 text-center">
    <div class="w-20 h-20 bg-teal-600 rounded-full flex items-center justify-center mx-auto shadow-xl text-white text-3xl mb-2">
        <i class="fa-solid fa-wrench"></i> ðŸ”§
    </div>
    <h1 class="text-3xl font-bold text-teal-700 dark:text-teal-400 tracking-widest uppercase">FIXZEN</h1>
  </div>

  <div class="w-full max-w-md bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-2xl fade border border-slate-200 dark:border-slate-700">

    <h2 id="title" class="text-2xl font-bold text-teal-600 dark:text-teal-400 mb-6 text-center">
      Login with OTP
    </h2>

    <div id="nameBox" class="hidden animate-fade-in-up">
      <label class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400">Full Name</label>
      <input id="name" class="w-full p-3 mt-1 mb-4 rounded-xl border bg-gray-50 focus:ring-2 focus:ring-teal-500 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="Enter your name">
    </div>

    <div id="techFields" class="hidden animate-fade-in-up">
      
      <label class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400">Aadhar Number</label>
      <input id="aadhar" class="w-full p-3 mt-1 mb-4 rounded-xl border bg-gray-50 focus:ring-2 focus:ring-teal-500 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="1234 5678 9012">

      <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400">Bank Account</label>
            <input id="bankAcc" class="w-full p-3 mt-1 mb-4 rounded-xl border bg-gray-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="Acc No.">
          </div>
          <div>
            <label class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400">IFSC Code</label>
            <input id="ifsc" class="w-full p-3 mt-1 mb-4 rounded-xl border bg-gray-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="IFSC">
          </div>
      </div>

      <label class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400">Profile Photo</label>
      <input id="techPhoto" type="file" accept="image/*"
             class="w-full p-2 mt-1 mb-4 rounded-xl border bg-gray-50 dark:bg-slate-700 dark:border-slate-600 text-sm">
      <img id="previewImg" class="hidden w-20 h-20 rounded-full object-cover mb-4 border-2 border-teal-500 mx-auto">
    </div>

    <label class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400">Phone Number</label>
    <div class="relative">
        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">+91</span>
        <input id="phone" type="tel" class="w-full p-3 pl-12 mt-1 rounded-xl border bg-gray-50 focus:ring-2 focus:ring-teal-500 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white font-bold tracking-widest" placeholder="9876543210" maxlength="10">
    </div>

    <div id="otpSection" class="hidden mt-4 animate-fade-in-up">
        <label class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400">One Time Password</label>
        <input id="otp" type="text" maxlength="6" class="w-full p-3 mt-1 rounded-xl border bg-teal-50 border-teal-200 text-center text-xl font-bold tracking-[0.5em] focus:ring-2 focus:ring-teal-500 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="000000">
    </div>

    <button id="sendOtpBtn" class="w-full bg-teal-600 hover:bg-teal-700 transition-colors text-white font-bold p-3.5 rounded-xl mt-6 shadow-lg shadow-teal-500/30">
        Send OTP
    </button>
    
    <button id="verifyOtpBtn" class="hidden w-full bg-teal-800 hover:bg-teal-900 transition-colors text-white font-bold p-3.5 rounded-xl mt-6 shadow-lg">
        Verify & Login
    </button>

    <p id="msg" class="text-center mt-4 text-xs font-bold uppercase tracking-widest min-h-[20px]"></p>

    <div class="mt-6 pt-6 border-t border-gray-100 dark:border-slate-700">
        <p class="text-center text-sm text-gray-600 dark:text-gray-300">
          <span id="toggleText">
            New user? <b class="text-teal-600 cursor-pointer hover:underline" onclick="switchToSignup()">Create account</b>
          </span>
        </p>

        <p class="text-center text-sm mt-3">
          <b id="techToggle" onclick="openTechSignup()" class="text-purple-600 cursor-pointer hover:underline">Join as Technician</b>
        </p>
    </div>

  </div>
  
  <p class="text-center text-gray-400 text-[10px] font-bold uppercase tracking-widest mt-8">Secured by FixZen</p>
</div>

<script>
    // 1. SUPABASE CONFIGURATION
    const SUPABASE_URL = 'https://kzxdxnxgouthsywbsnvl.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6eGR4bnhnb3V0aHN5d2JzbnZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMTczMzIsImV4cCI6MjA4MTg5MzMzMn0.nqzn89vmTFKVNuZPHfGRxdTg6UHT6GMud238rr49qag';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // STATE
    let isSignup = false;
    let isTech = false;

    // DOM ELEMENTS
    const els = {
        title: document.getElementById("title"),
        nameBox: document.getElementById("nameBox"),
        techFields: document.getElementById("techFields"),
        toggleText: document.getElementById("toggleText"),
        techToggle: document.getElementById("techToggle"),
        otpSection: document.getElementById("otpSection"),
        sendBtn: document.getElementById("sendOtpBtn"),
        verifyBtn: document.getElementById("verifyOtpBtn"),
        phone: document.getElementById("phone"),
        otp: document.getElementById("otp"),
        msg: document.getElementById("msg"),
        name: document.getElementById("name")
    };

    // --- UI FUNCTIONS ---
    
    function showMsg(text, type = 'error') {
        els.msg.innerText = text;
        els.msg.className = `text-center mt-4 text-xs font-bold uppercase tracking-widest ${type === 'success' ? 'text-green-500' : 'text-red-500'}`;
    }

    function setLoading(btn, isLoading) {
        if(isLoading) {
            btn.innerHTML = '<span class="loader"></span> Processing...';
            btn.disabled = true;
            btn.classList.add('opacity-70', 'cursor-not-allowed');
        } else {
            btn.innerHTML = btn.id === 'sendOtpBtn' ? 'Send OTP' : 'Verify & Login';
            btn.disabled = false;
            btn.classList.remove('opacity-70', 'cursor-not-allowed');
        }
    }

    function switchToSignup() {
        isSignup = true; isTech = false;
        els.title.innerText = "Create Account";
        els.nameBox.classList.remove("hidden");
        els.techFields.classList.add("hidden");
        els.toggleText.innerHTML = `Already have an account? <b class="text-teal-600 cursor-pointer hover:underline" onclick="switchToLogin()">Login</b>`;
        els.techToggle.classList.remove("hidden");
    }

    function switchToLogin() {
        isSignup = false; isTech = false;
        els.title.innerText = "Login with OTP";
        els.nameBox.classList.add("hidden");
        els.techFields.classList.add("hidden");
        els.toggleText.innerHTML = `New user? <b class="text-teal-600 cursor-pointer hover:underline" onclick="switchToSignup()">Create account</b>`;
        els.techToggle.classList.remove("hidden");
    }

    function openTechSignup() {
        isTech = true; isSignup = true;
        els.title.innerText = "Technician Registration";
        els.nameBox.classList.remove("hidden");
        els.techFields.classList.remove("hidden");
        els.toggleText.innerHTML = `<b class='text-blue-600 cursor-pointer hover:underline' onclick="switchToLogin()">Back to Login</b>`;
        els.techToggle.classList.add("hidden");
    }

    // --- AUTH LOGIC (REAL SUPABASE) ---

    // 1. SEND OTP
    els.sendBtn.onclick = async () => {
        const phone = els.phone.value.trim();
        if(phone.length !== 10) return showMsg("Enter valid 10-digit number");
        
        setLoading(els.sendBtn, true);
        
        try {
            // Sign in with OTP
            const { error } = await supabase.auth.signInWithOtp({
                phone: '+91' + phone
            });

            if (error) throw error;

            showMsg("OTP Sent Successfully!", "success");
            els.otpSection.classList.remove("hidden");
            els.sendBtn.classList.add("hidden");
            els.verifyBtn.classList.remove("hidden");
            
        } catch (err) {
            showMsg(err.message);
        } finally {
            setLoading(els.sendBtn, false);
        }
    };

    // 2. VERIFY OTP & REGISTER
    els.verifyBtn.onclick = async () => {
        const phone = els.phone.value.trim();
        const otp = els.otp.value.trim();
        
        if(otp.length !== 6) return showMsg("Enter 6-digit OTP");

        setLoading(els.verifyBtn, true);

        try {
            // Verify OTP
            const { data, error } = await supabase.auth.verifyOtp({
                phone: '+91' + phone,
                token: otp,
                type: 'sms'
            });

            if (error) throw error;

            const user = data.user;
            
            // CHECK OR CREATE PROFILE
            if (isSignup) {
                const fullName = els.name.value;
                if(!fullName) throw new Error("Name is required");

                const profileData = {
                    id: user.id,
                    phone: '+91' + phone,
                    full_name: fullName,
                    role: isTech ? 'technician' : 'customer',
                    status: isTech ? 'active' : 'active',
                    // Save extra tech details if needed (in a real app you'd upload the photo too)
                    details: isTech ? {
                        aadhar: document.getElementById('aadhar').value,
                        bank: document.getElementById('bankAcc').value,
                        ifsc: document.getElementById('ifsc').value
                    } : null
                };

                // Upsert Profile
                const { error: profileError } = await supabase
                    .from('profiles')
                    .upsert(profileData);

                if (profileError) console.error(profileError);
            }

            // REDIRECT LOGIC
            showMsg("Success! Redirecting...", "success");
            
            // Check where to go
            const redirectTo = sessionStorage.getItem('redirect_to');
            sessionStorage.removeItem('redirect_to'); // Clear it

            setTimeout(() => {
                if (isTech) {
                    window.location.href = "techniciandashboard.html";
                } else if (redirectTo) {
                    window.location.href = redirectTo; // Go back to where they clicked "Book"
                } else {
                    window.location.href = "index.html";
                }
            }, 1000);

        } catch (err) {
            showMsg("Invalid Code or Error: " + err.message);
            setLoading(els.verifyBtn, false);
        }
    };

    // Photo Preview Logic (Visual)
    const techPhoto = document.getElementById("techPhoto");
    const previewImg = document.getElementById("previewImg");
    if(techPhoto){
        techPhoto.addEventListener("change", e => {
            const file = e.target.files[0];
            if(file){
                previewImg.src = URL.createObjectURL(file);
                previewImg.classList.remove("hidden");
            }
        });
    }
</script>

</body>
</html>
