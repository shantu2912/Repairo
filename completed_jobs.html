<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FixZen Pro | Completed Jobs</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Alpine -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Icons / Fonts -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Playfair+Display:ital,wght@1,600&display=swap" rel="stylesheet">

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'brand-olive': '#5D5646',
        'brand-gold': '#A07D54',
        'brand-cream': '#F8F5F0',
        'brand-dark': '#2D2B28',
        'brand-beige': '#DFD4C3'
      }
    }
  }
}
</script>

<style>
[x-cloak]{display:none}
body{background:#F8F5F0;color:#2D2B28}
.glass-card{
  background:rgba(255,255,255,.95);
  backdrop-filter:blur(18px);
  border:1px solid #fff;
  box-shadow:0 15px 35px rgba(93,86,70,.08)
}
</style>

<!-- SUPABASE -->
<script>
window.sb = supabase.createClient(
  "https://kzxdxnxgouthsywbsnvl.supabase.co",
   "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6eGR4bnhnb3V0aHN5d2JzbnZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMTczMzIsImV4cCI6MjA4MTg5MzMzMn0.nqzn89vmTFKVNuZPHfGRxdTg6UHT6GMud238rr49qag"
);
</script>
</head>

<body
x-data="completedJobsHandler()"
x-init="init()"
x-cloak
class="font-sans antialiased pb-24"
>

<!-- HEADER -->
<header class="sticky top-0 z-50 bg-brand-cream/80 backdrop-blur border-b p-5">
  <div class="max-w-md mx-auto flex items-center gap-4">
    <button onclick="window.location.href='techniciandashboard.html'"
            class="text-brand-olive">
      <i class="fa-solid fa-arrow-left"></i>
    </button>
    <div>
      <p class="text-[10px] uppercase tracking-widest text-brand-gold font-black">
        Job History
      </p>
      <p class="font-serif italic text-lg text-brand-olive">
        Completed Jobs
      </p>
    </div>
  </div>
</header>

<main class="max-w-md mx-auto p-6 space-y-6">

<!-- LOADING -->
<div x-show="loading" class="text-center text-sm text-brand-dark/50 mt-20">
  Loading completed jobsâ€¦
</div>

<!-- EMPTY -->
<div x-show="!loading && jobs.length === 0"
     class="text-center text-sm text-brand-dark/50 mt-20">
  No completed jobs yet
</div>

<!-- JOB LIST -->
<template x-for="job in jobs" :key="job.id">
  <div class="glass-card p-6 rounded-[2.5rem]">

    <span class="text-[9px] font-bold text-brand-gold uppercase"
          x-text="job.category"></span>

    <h4 class="text-lg font-extrabold text-brand-olive"
        x-text="job.device"></h4>

    <p class="text-xs italic text-brand-dark/60"
       x-text="job.issue"></p>

    <div class="flex justify-between items-center border-t mt-4 pt-4">

      <!-- CUSTOMER -->
      <div>
        <p class="text-sm font-bold" x-text="job.customer_name"></p>
        <p class="text-[9px] uppercase text-brand-dark/40"
           x-text="job.location"></p>
        <p class="text-[9px] text-brand-dark/50 mt-1">
          Completed on:
          <span x-text="formatDate(job.completed_at)"></span>
        </p>
      </div>

      <!-- STATUS -->
      <span
        class="text-[9px] font-black uppercase px-3 py-1 rounded-full bg-green-100 text-green-700">
        Completed
      </span>

    </div>

  </div>
</template>

</main>

<!-- LOGIC -->
<script>
function completedJobsHandler(){
return{
  loading:true,
  jobs:[],

  async init(){
    const tech = JSON.parse(localStorage.getItem("active_tech"));
    if(!tech){
      window.location.href="partnerlogin.html";
      return;
    }
    await this.fetchCompleted();
  },

  async fetchCompleted(){
    this.loading = true;

    const { data, error } = await window.sb
      .from("jobs")
      .select("*")
      .eq("status","completed")
      .order("completed_at",{ascending:false});

    if(error){
      console.error(error);
      this.loading = false;
      return;
    }

    this.jobs = data;
    this.loading = false;
  },

  formatDate(dt){
    if(!dt) return "-";
    const d = new Date(dt);
    return d.toLocaleDateString("en-IN",{
      day:"2-digit",
      month:"short",
      year:"numeric"
    });
  }
}
}
</script>

</body>
</html>
