<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Repairo — Track Booking</title>

  <link rel="stylesheet" href="style.css">

  <!-- Leaflet Map CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    .track-card {
      background: white;
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }

    .status-step {
      padding: 8px 12px;
      border-left: 4px solid #ccc;
      margin: 8px 0;
    }

    .status-step.active {
      border-left: 4px solid #0ea5e9;
      background: #f0f9ff;
    }

    #map {
      height: 280px;
      width: 100%;
      border-radius: 12px;
      margin-top: 12px;
    }
  </style>
</head>

<body>

<header class="site-header">
  <div class="container header-inner">
    <div class="brand">
      <div class="logo-mark">R</div>
      <div>
        <div class="brand-title">Repairo</div>
        <div class="brand-sub">Booking Tracking</div>
      </div>
    </div>

    <nav class="main-nav">
      <a href="index.html">Home</a>
      <a href="services.html">Services</a>
      <a href="profile.html">Profile</a>
    </nav>
  </div>
</header>

<main class="container">

  <section class="track-card">
    <h2 id="svcName">Loading…</h2>
    <p class="muted" id="svcAddr"></p>

    <h3 style="margin-top:18px;">Status Timeline</h3>
    <div id="timeline"></div>
  </section>

  <section class="track-card">
    <h3>Technician</h3>
    <p id="techInfo" class="muted">Assigning technician…</p>
  </section>

  <section class="track-card">
    <h3>Live Map</h3>
    <div id="map"></div>
  </section>

</main>

<footer class="site-footer">
  <div class="container footer-inner">
    <div>© 2025 Repairo</div>
    <div class="footer-links">
      <a href="about.html">About</a>
      <a href="services.html">Services</a>
    </div>
  </div>
</footer>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const params = new URLSearchParams(location.search);
const bookingId = params.get("booking");

if (!bookingId) {
  document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px;'>Invalid tracking link</h2>";
  throw "";
}

let map, marker;

/* Fetch booking from localStorage */
function loadBooking() {
  const arr = JSON.parse(localStorage.getItem("repairo_bookings") || "[]");
  return arr.find(x => x.id === bookingId);
}

function renderTracking() {
  const b = loadBooking();

  if (!b) {
    document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px;'>Booking not found</h2>";
    return;
  }

  document.getElementById("svcName").innerText = b.service.replace(/_/g," ");
  document.getElementById("svcAddr").innerText = b.addr + " • " + b.date + " " + (b.time || "");

  /* Technician info */
  if (b.technician) {
    document.getElementById("techInfo").innerText = "Technician: " + b.technician + " (demo)";
  }

  /* Status timeline */
  const order = ["pending", "assigned", "enroute", "started", "completed"];
  const timeline = document.getElementById("timeline");
  timeline.innerHTML = "";

  order.forEach(st => {
    const div = document.createElement("div");
    div.className = "status-step" + (b.status === st ? " active" : "");
    div.innerText = st.toUpperCase();
    timeline.appendChild(div);
  });

  /* Initialize map first time */
  if (!map) {
    map = L.map('map').setView([20.9333, 77.7500], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    marker = L.marker([20.937424,77.779549]).addTo(map);
  }

  /* Demo: simulate tech moving around */
  const lat = 19.07 + Math.random() * 0.01;
  const lng = 72.88 + Math.random() * 0.01;

  marker.setLatLng([lat, lng]);
  map.setView([lat, lng]);
}

/* First load */
renderTracking();

/* Auto-refresh every 4 sec */
setInterval(renderTracking, 4000);

</script>

</body>
</html>
