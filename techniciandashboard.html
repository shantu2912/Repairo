<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FixZen Pro | Expert Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>

<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=Playfair+Display:ital,wght@1,600&display=swap" rel="stylesheet">

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'brand-olive': '#5D5646',
        'brand-gold': '#A07D54',
        'brand-cream': '#F8F5F0',
        'brand-dark': '#2D2B28',
        'brand-green': '#10B981'
      },
      animation: {
        'shimmer': 'shimmer 1.5s infinite linear',
        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite'
      },
      keyframes: {
        shimmer: {
          '0%': { backgroundPosition: '-1000px 0' },
          '100%': { backgroundPosition: '1000px 0' }
        }
      }
    }
  }
}
</script>
<style>
[x-cloak]{display:none !important}
body { background: #F8F5F0; color: #2D2B28; font-family: 'Plus Jakarta Sans', sans-serif; }
.glass-panel { background: rgba(255,255,255,0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.5); }
.glass-card { background: #ffffff; box-shadow: 0 10px 40px rgba(93,86,70,0.08); border: 1px solid rgba(255,255,255,0.8); }
.ios-switch:checked { background-color: #10B981; }
.ios-switch:checked::before { transform: translateX(20px); }
</style>

<script>
window.sb = supabase.createClient(
  "https://kzxdxnxgouthsywbsnvl.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6eGR4bnhnb3V0aHN5d2JzbnZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMTczMzIsImV4cCI6MjA4MTg5MzMzMn0.nqzn89vmTFKVNuZPHfGRxdTg6UHT6GMud238rr49qag"
);
</script>
</head>

<body x-data="dashboardHandler()" x-init="init()" x-cloak class="antialiased pb-32">

<header class="sticky top-0 z-40 glass-panel border-b border-gray-100 shadow-sm">
  <div class="max-w-md mx-auto px-5 py-4 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <div class="w-12 h-12 rounded-full bg-gradient-to-br from-brand-olive to-brand-dark text-white flex items-center justify-center font-bold text-xl shadow-lg border-2 border-white">
        <span x-text="techName.charAt(0)"></span>
      </div>
      <div>
        <div class="flex items-center gap-1.5">
            <p class="font-bold text-brand-dark text-lg leading-none" x-text="techName"></p>
            <span class="w-2 h-2 rounded-full animate-pulse-fast" :class="available ? 'bg-brand-green' : 'bg-red-500'"></span>
        </div>
        <p class="text-[10px] uppercase tracking-widest text-brand-gold font-bold mt-1">Verified Expert</p>
      </div>
    </div>
    <button @click="logout()" class="w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all shadow-sm">
      <i class="fa-solid fa-power-off"></i>
    </button>
  </div>
</header>

<main class="max-w-md mx-auto p-5 space-y-6">

<section>
  <div class="flex justify-between items-center mb-4 px-1">
    <h2 class="font-extrabold text-brand-dark text-lg">Dashboard</h2>
    <label class="flex items-center cursor-pointer">
      <div class="relative">
        <input type="checkbox" class="sr-only ios-switch" x-model="available" @change="toggleAvailability()">
        <div class="block bg-gray-300 w-12 h-7 rounded-full transition-colors duration-300" :class="available ? 'bg-brand-green' : ''"></div>
        <div class="absolute left-1 top-1 bg-white w-5 h-5 rounded-full transition-transform duration-300 shadow-sm flex items-center justify-center" :class="available ? 'translate-x-5' : ''"></div>
      </div>
      <span class="ml-2 text-xs font-bold text-gray-600" x-text="available ? 'Online' : 'Offline'"></span>
    </label>
  </div>

  <div class="grid grid-cols-2 gap-4">
    <div class="glass-card p-5 rounded-[2rem] relative overflow-hidden group hover:scale-[1.02] transition-transform">
      <div class="absolute -right-4 -top-4 w-16 h-16 bg-brand-gold/10 rounded-full group-hover:scale-150 transition-transform"></div>
      <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Jobs Done</p>
      <h3 class="text-3xl font-extrabold text-brand-dark mt-1" x-text="stats.activeJobs"></h3>
    </div>
    <div class="glass-card p-5 rounded-[2rem] relative overflow-hidden group hover:scale-[1.02] transition-transform">
      <div class="absolute -right-4 -top-4 w-16 h-16 bg-green-500/10 rounded-full group-hover:scale-150 transition-transform"></div>
      <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Today's Pay</p>
      <h3 class="text-3xl font-extrabold text-brand-green mt-1">₹<span x-text="stats.todayEarnings"></span></h3>
    </div>
  </div>
</section>

<section id="jobsSection" class="pt-2">

  <template x-if="loading">
    <div class="space-y-4 animate__animated animate__fadeIn">
      <div class="glass-card p-6 rounded-[2.5rem] relative overflow-hidden h-40">
        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-gray-100/50 to-transparent animate-shimmer" style="background-size: 1000px 100%;"></div>
        <div class="w-1/3 h-4 bg-gray-200 rounded mb-4"></div>
        <div class="w-3/4 h-6 bg-gray-200 rounded mb-2"></div>
        <div class="w-1/2 h-4 bg-gray-200 rounded"></div>
      </div>
    </div>
  </template>

  <template x-if="!loading && activeJob">
    <div class="animate__animated animate__fadeInUp">
        <div class="flex items-center justify-between mb-3 px-1">
            <h3 class="font-extrabold text-brand-gold uppercase tracking-widest text-xs flex items-center gap-2">
                <i class="fa-solid fa-lock"></i> Active Job Locked
            </h3>
        </div>

        <div class="glass-card rounded-[2.5rem] p-6 border-2 border-brand-gold shadow-2xl relative overflow-hidden">
            <div class="absolute -top-20 -right-20 w-40 h-40 bg-brand-gold/10 blur-3xl rounded-full"></div>

            <div class="flex justify-between items-start mb-6 relative z-10">
                <div>
                    <span class="text-[10px] font-bold text-white bg-brand-dark px-3 py-1 rounded-full uppercase tracking-wider" x-text="activeJob.category"></span>
                    <h4 class="text-2xl font-extrabold text-brand-dark mt-3 leading-tight" x-text="activeJob.customer_name"></h4>
                    <p class="text-xs text-gray-500 mt-1 font-medium bg-gray-50 inline-block px-3 py-1 rounded-lg border border-gray-100"><i class="fa-solid fa-phone mr-1 text-brand-gold"></i> <span x-text="activeJob.phone"></span></p>
                </div>
                <div class="w-12 h-12 rounded-2xl bg-brand-cream flex items-center justify-center text-brand-gold text-xl border border-brand-beige">
                    <i class="fa-solid fa-user-astronaut"></i>
                </div>
            </div>

            <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 mb-6 flex gap-4 items-center">
                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center shrink-0">
                    <i class="fa-solid fa-map-pin"></i>
                </div>
                <div class="flex-1">
                    <p class="text-[9px] font-bold text-gray-400 uppercase tracking-wider">Service Location</p>
                    <p class="text-sm font-bold text-gray-800 line-clamp-2 leading-snug mt-0.5" x-text="activeJob.location"></p>
                </div>
            </div>

            <div class="space-y-3 relative z-10">
                
                <template x-if="activeJob.status === 'in_progress'">
                    <div class="space-y-3 animate__animated animate__fadeIn">
                        <div class="flex gap-3">
                            <a :href="'https://www.google.com/maps/dir/?api=1&destination=' + encodeURIComponent(activeJob.location)" target="_blank" class="flex-1 py-3.5 bg-blue-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-200 hover:bg-blue-600 transition-all active:scale-95 text-sm">
                                <i class="fa-solid fa-location-arrow"></i> Navigate
                            </a>
                            <a :href="'tel:' + activeJob.phone" class="w-14 bg-gray-100 text-gray-700 rounded-xl flex items-center justify-center text-lg hover:bg-gray-200 transition-all border border-gray-200">
                                <i class="fa-solid fa-phone"></i>
                            </a>
                        </div>
                        <button @click="triggerOtpFlow()" class="w-full py-4 bg-brand-dark text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-xl hover:bg-black transition-all active:scale-95">
                            I Have Arrived <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                </template>

                <template x-if="activeJob.status === 'arrived'">
                    <div class="bg-brand-cream border border-brand-gold rounded-2xl p-5 text-center animate__animated animate__zoomIn shadow-inner">
                        <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center mx-auto mb-2 text-brand-gold shadow-sm">
                            <i class="fa-solid fa-key"></i>
                        </div>
                        <h4 class="font-extrabold text-brand-dark mb-1">Enter Start Code</h4>
                        <p class="text-[10px] font-bold text-gray-500 mb-4 uppercase tracking-wider">Ask customer for the 4-digit OTP</p>
                        
                        <input type="number" x-model="enteredOtp" placeholder="••••" class="w-32 mx-auto text-center text-3xl font-black tracking-widest bg-white border border-gray-300 rounded-xl py-2 focus:ring-2 focus:ring-brand-gold focus:outline-none mb-4 shadow-sm text-brand-dark">
                        
                        <button @click="verifyOtp()" class="w-full py-3.5 bg-brand-gold text-white rounded-xl font-bold shadow-lg shadow-brand-gold/30 hover:bg-[#8A6A45] transition-all active:scale-95 flex items-center justify-center gap-2">
                            Verify & Start Work <i class="fa-solid fa-check"></i>
                        </button>
                    </div>
                </template>

                <template x-if="activeJob.status === 'started'">
                    <div class="space-y-4 animate__animated animate__fadeIn">
                        <div class="bg-green-50 border border-green-200 rounded-2xl p-4 flex items-center gap-4 shadow-sm">
                            <div class="w-12 h-12 bg-green-500 text-white rounded-full flex items-center justify-center text-xl shrink-0 shadow-inner">
                                <i class="fa-solid fa-hammer"></i>
                            </div>
                            <div>
                                <h4 class="font-extrabold text-green-800">Work in Progress</h4>
                                <p class="text-xs text-green-600 font-medium">OTP Verified Successfully</p>
                            </div>
                        </div>
                        <button @click="completeJob()" class="w-full py-4 bg-brand-green text-white rounded-xl font-extrabold flex items-center justify-center gap-2 shadow-xl shadow-green-200 hover:bg-green-600 transition-all active:scale-95 text-lg">
                            <i class="fa-solid fa-check-double"></i> Mark Job Completed
                        </button>
                    </div>
                </template>

            </div>
        </div>
    </div>
  </template>

  <template x-if="!loading && !activeJob">
    <div class="animate__animated animate__fadeIn">
      <div class="flex justify-between items-center mb-4 px-1 mt-6">
        <h3 class="font-extrabold text-brand-dark">Available Requests</h3>
        <span class="bg-gray-200 text-gray-600 text-[10px] font-bold px-2 py-1 rounded-full" x-text="pendingJobs.length + ' Jobs'"></span>
      </div>

      <template x-if="pendingJobs.length === 0">
        <div class="glass-card rounded-[2rem] p-10 text-center flex flex-col items-center justify-center min-h-[250px] border-dashed border-2 border-gray-200">
          <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mb-4 text-gray-300 shadow-inner">
            <i class="fa-solid fa-mug-hot text-3xl"></i>
          </div>
          <h4 class="font-bold text-gray-800 text-lg">You're all caught up!</h4>
          <p class="text-xs text-gray-400 mt-2 font-medium">Stay online. We'll alert you when a customer books near you.</p>
        </div>
      </template>

      <div class="space-y-4">
        <template x-for="job in pendingJobs" :key="job.id">
          <div class="glass-card p-5 rounded-[2rem] border-l-[6px] border-brand-gold hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
            <div class="flex justify-between items-start mb-3">
              <div>
                <span class="text-[9px] font-bold text-brand-gold uppercase tracking-wider bg-brand-cream px-2 py-1 rounded-md" x-text="job.category"></span>
                <h4 class="text-lg font-extrabold text-brand-dark mt-2 leading-tight" x-text="job.device || 'Service Request'"></h4>
              </div>
              <span class="text-xs font-bold text-gray-400" x-text="formatTime(job.created_at)"></span>
            </div>
            
            <p class="text-xs text-gray-600 mb-4 line-clamp-2 bg-gray-50 p-2 rounded-lg border border-gray-100" x-text="job.issue"></p>
            
            <div class="flex items-center gap-2 mb-5 text-xs text-gray-500 font-medium">
              <i class="fa-solid fa-location-dot text-brand-gold"></i>
              <span class="line-clamp-1" x-text="job.location"></span>
            </div>

            <div class="flex gap-3">
              <button @click="rejectJob(job.id)" class="px-5 py-3 bg-gray-100 text-gray-500 text-xs font-bold rounded-xl hover:bg-gray-200 transition-colors">
                Ignore
              </button>
              <button @click="acceptJob(job.id)" class="flex-1 py-3 bg-brand-gold text-white text-sm font-bold rounded-xl shadow-lg shadow-brand-gold/30 hover:bg-brand-dark transition-all active:scale-95 flex items-center justify-center gap-2">
                Accept Job <i class="fa-solid fa-arrow-right"></i>
              </button>
            </div>
          </div>
        </template>
      </div>
    </div>
  </template>

</section>
</main>

<nav class="fixed bottom-6 w-full z-50 px-5 pointer-events-none">
  <div class="max-w-sm mx-auto pointer-events-auto glass-panel rounded-full px-6 py-3.5 flex justify-between items-center shadow-2xl border border-white/40">
    <button class="w-10 h-10 text-brand-gold flex flex-col items-center justify-center gap-1">
      <i class="fa-solid fa-house text-lg"></i>
    </button>
    <button onclick="window.location.href='completed_jobs.html'" class="w-10 h-10 text-gray-400 hover:text-brand-gold transition-colors flex flex-col items-center justify-center gap-1">
      <i class="fa-solid fa-clipboard-check text-lg"></i>
    </button>
    <button @click="logout()" class="w-10 h-10 text-gray-400 hover:text-brand-gold transition-colors flex flex-col items-center justify-center gap-1">
      <i class="fa-solid fa-user text-lg"></i>
    </button>
  </div>
</nav>

<script>
const firebaseConfig = {
   apiKey: "AIzaSyCFCS5Epty691ONqtUqcngfV-Fz53j6x_o",
  authDomain: "fixzen-73d68.firebaseapp.com",
  projectId: "fixzen-73d68",
  messagingSenderId: "816193738840",
  appId: "1:816193738840:web:7ba3545e56d3538bf7522d"
};
firebase.initializeApp(firebaseConfig);
const messaging = firebase.messaging();
</script>

<script>
function dashboardHandler() {
  return {
    tech: null,
    techName: '',
    loading: true,
    available: true,
    
    // UI States
    activeJob: null, // The locked job
    pendingJobs: [], // The list of available jobs
    
    // OTP System
    systemOtp: '',
    enteredOtp: '',

    stats: { activeJobs: 0, earnings: 0, todayEarnings: 0 },

    async init() {
      // 1. Check Local Storage
      this.tech = JSON.parse(localStorage.getItem("active_tech"));
      if (!this.tech) {
          window.location.href = "partnerlogin.html";
          return;
      }
      this.techName = this.tech.name;
      
      // 2. Setup Firebase Notifications
      await this.setupNotifications();
      messaging.onMessage((payload) => {
        new Notification(payload.notification?.title || "New Job", {
          body: payload.notification?.body, icon: "/icon-192.png"
        });
      });

      // 3. Load Data & Subscribe
      await this.fetchJobs();
      this.subscribeRealtime();
    },

    toggleAvailability() {
      console.log("Technician availability set to:", this.available);
      // You can add a DB update here if you have an 'is_online' column in technicians table
    },

    async setupNotifications() {
      try {
        if (!('serviceWorker' in navigator)) return;
        const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
        const permission = await Notification.requestPermission();
        if (permission !== "granted") return;
        const token = await messaging.getToken({
          vapidKey: "BBZpS8kGM1KZEP1f0L9TeEM-WHUAKND52kqpPPb-9I1EuWNlXItKHaRGqNkrmOKPzjhvtP3oysjZ8Dq1SuN4yBk",
          serviceWorkerRegistration: registration
        });
        if (token) {
          await window.sb.from("technicians").update({ fcm_token: token }).eq("id", this.tech.id);
        }
      } catch (err) { console.error("Notification setup failed", err); }
    },

    async fetchJobs() {
      this.loading = true;
      
      // Fetch all jobs relevant to this tech OR pending jobs
      const { data, error } = await window.sb
        .from("jobs")
        .select("*")
        .or(`and(status.eq.pending,tech_id.is.null),tech_id.eq.${this.tech.id}`)
        .order("created_at", { ascending: false });

      if (!error && data) {
        // Filter out jobs this tech rejected
        const visibleJobs = data.filter(j => !(j.rejected_by || []).includes(this.tech.id));

        // 1. Determine if Tech has an ACTIVE lock (in_progress, arrived, started)
        const activeStatuses = ['in_progress', 'arrived', 'started'];
        const myActiveJob = visibleJobs.find(j => j.tech_id === this.tech.id && activeStatuses.includes(j.status));
        
        if (myActiveJob) {
          this.activeJob = myActiveJob;
          this.pendingJobs = []; // Hide pending if locked
        } else {
          this.activeJob = null;
          this.pendingJobs = visibleJobs.filter(j => j.status === 'pending' && !j.tech_id);
        }

        this.calculateStats(visibleJobs);
      }
      this.loading = false;
    },

    calculateStats(allData) {
      // Completed Jobs count
      const completedJobs = allData.filter(j => j.status === 'completed' && j.tech_id === this.tech.id);
      this.stats.activeJobs = completedJobs.length;

      // Total Earnings
      this.stats.earnings = completedJobs.reduce((sum, job) => sum + (job.technician_fee || 0), 0);
      
      // Today's Earnings
      const today = new Date().toISOString().split('T')[0];
      this.stats.todayEarnings = completedJobs
        .filter(j => j.completed_at?.startsWith(today))
        .reduce((sum, j) => sum + (job.technician_fee || 0), 0);
    },

    subscribeRealtime() {
      window.sb.channel(`public-jobs`)
        .on("postgres_changes", { event: "*", schema: "public", table: "jobs" }, () => {
          this.fetchJobs(); // Instant refresh on any DB change
        }).subscribe();
    },

    // --- ACTIONS ---

    async acceptJob(jobId) {
      // Security: Only update if it's STILL pending
      const { data, error } = await window.sb.from("jobs")
        .update({ tech_id: this.tech.id, status: "in_progress", started_at: new Date().toISOString() })
        .eq("id", jobId)
        .is("tech_id", null)
        .eq("status", "pending")
        .select();

      if (error || !data || data.length === 0) {
        alert("Too late. Another expert already took this job.");
        this.fetchJobs();
        return;
      }
      // Success - refresh UI to show Focus Mode
      this.fetchJobs();
    },

    async rejectJob(jobId) {
      const job = this.pendingJobs.find(j => j.id === jobId);
      if (!job) return;
      
      const currentRejected = job.rejected_by || [];
      await window.sb.from("jobs").update({ rejected_by: [...currentRejected, this.tech.id] }).eq("id", jobId);
      
      // Remove instantly from UI
      this.pendingJobs = this.pendingJobs.filter(j => j.id !== jobId);
    },

    // OTP FLOW
    async triggerOtpFlow() {
      // Generate OTP
      this.systemOtp = Math.floor(1000 + Math.random() * 9000).toString();
      
      // Simulated SMS sending alert
      alert(`[SYSTEM SMS] Sent to Customer: "Your FixZen expert has arrived. Start Code: ${this.systemOtp}"`);
      
      // Update DB to "arrived"
      await window.sb.from('jobs').update({ status: 'arrived', arrived_at: new Date().toISOString() }).eq('id', this.activeJob.id);
      
      this.activeJob.status = 'arrived';
      this.enteredOtp = '';
    },

    async verifyOtp() {
      if (this.enteredOtp === this.systemOtp) {
        await window.sb.from('jobs').update({ status: 'started' }).eq('id', this.activeJob.id);
        this.activeJob.status = 'started';
      } else {
        alert("Incorrect Start Code. Please verify with the customer.");
        this.enteredOtp = '';
      }
    },

    async completeJob() {
      if(!confirm("Are you sure you have finished this work?")) return;
      
      const fee = this.calculateFee(this.activeJob);
      const { error } = await window.sb.from("jobs")
        .update({ status: "completed", completed_at: new Date().toISOString(), technician_fee: fee })
        .eq("id", this.activeJob.id)
        .eq("tech_id", this.tech.id);

      if (error) {
        alert("Failed to complete job.");
        return;
      }
      
      alert("Job marked as completed! Earnings added to your wallet.");
      
      // Unlock dashboard
      this.activeJob = null;
      this.fetchJobs(); 
    },

    formatTime(dt){
      if(!dt) return "-";
      const diff = Math.floor((Date.now() - new Date(dt)) / 60000);
      if(diff < 1) return "just now";
      if(diff < 60) return diff + " mins ago";
      const hours = Math.floor(diff / 60);
      if(hours < 24) return hours + " hrs ago";
      return Math.floor(hours / 24) + " days ago";
    },

    calculateFee(job){
      const BASE = { "Carpenter": 800, "Plumber": 600, "Electrician": 600, "Painter": 600, "Mason": 600, "Welder": 600, "Roofer": 600, "AC Tech": 600 };
      return BASE[job.category] ?? 400;
    },

    logout(){
      localStorage.removeItem("active_tech");
      window.location.href = "partnerlogin.html";
    }
  }
}
</script>
</body>
</html>
