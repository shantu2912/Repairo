<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FixZen Pro | Technician Dashboard</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Alpine -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Icons / Fonts -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Playfair+Display:ital,wght@1,600&display=swap" rel="stylesheet">

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'brand-olive': '#5D5646',
        'brand-gold': '#A07D54',
        'brand-cream': '#F8F5F0',
        'brand-dark': '#2D2B28',
        'brand-beige': '#DFD4C3'
      }
    }
  }
}
</script>
<style>
[x-cloak]{display:none}
body{background:#F8F5F0;color:#2D2B28}
.glass-card{
  background:rgba(255,255,255,.95);
  backdrop-filter:blur(18px);
  border:1px solid #fff;
  box-shadow:0 15px 35px rgba(93,86,70,.08)
}
</style>

<!-- ✅ SUPABASE CLIENT -->
<script>
window.sb = supabase.createClient(
  "https://kzxdxnxgouthsywbsnvl.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6eGR4bnhnb3V0aHN5d2JzbnZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMTczMzIsImV4cCI6MjA4MTg5MzMzMn0.nqzn89vmTFKVNuZPHfGRxdTg6UHT6GMud238rr49qag"
);
</script>
</head>

<body
x-data="dashboardHandler()"
x-init="init()"
x-cloak
class="font-sans antialiased pb-36"
>

<!-- HEADER -->
<header class="sticky top-0 z-50 bg-brand-cream/80 backdrop-blur border-b p-5">
  <div class="max-w-md mx-auto flex justify-between items-center">
    <div class="flex items-center gap-3">
      <div class="w-12 h-12 rounded-full bg-brand-olive text-white flex items-center justify-center font-bold">
        <span x-text="techName.charAt(0)"></span>
      </div>
      <div>
        <p class="text-[10px] uppercase tracking-widest text-brand-gold font-black">Pro Partner</p>
        <p class="font-serif italic text-lg text-brand-olive" x-text="techName"></p>
      </div>
    </div>
    <button @click="logout()" class="text-brand-olive hover:text-red-500">
      <i class="fa-solid fa-power-off"></i>
    </button>
  </div>
</header>

<main class="max-w-md mx-auto p-6 space-y-8">

<!-- STATS -->
<section>
  <div class="grid grid-cols-2 gap-4">
    <div class="glass-card p-5 rounded-[2rem]">
      <p class="text-[9px] font-bold text-brand-gold uppercase">Active Jobs</p>
      <h3 class="text-3xl font-extrabold text-brand-olive" x-text="stats.activeJobs"></h3>
    </div>
    <div class="glass-card p-5 rounded-[2rem]">
      <p class="text-[9px] font-bold text-brand-gold uppercase">Earnings</p>
      <h3 class="text-3xl font-extrabold text-green-700">
        ₹<span x-text="stats.earnings"></span>
      </h3>
    </div>
  </div>
</section>

<!-- JOBS -->
<section id="jobsSection" class="space-y-4">

  <div x-show="loading" class="text-center text-sm text-brand-dark/50 mt-20">
    Loading jobs…
  </div>

  <div x-show="!loading && jobs.length === 0"
       class="text-center text-sm text-brand-dark/50 mt-20">
    No active jobs
  </div>

  <template x-for="job in jobs" :key="job.id">
    <div class="glass-card p-6 rounded-[2.5rem] border-l-4"
         :class="job.urgent ? 'border-red-500':'border-brand-gold'">

      <!-- TITLE -->
      <span class="text-[9px] font-bold text-brand-gold uppercase" x-text="job.category"></span>
      <h4 class="text-lg font-extrabold text-brand-olive" x-text="job.device"></h4>
      <p class="text-xs italic text-brand-dark/60" x-text="job.issue"></p>

      <!-- FOOTER -->
      <div class="flex justify-between items-center border-t mt-4 pt-4">

        <!-- CUSTOMER -->
        <div>
          <p class="text-sm font-bold" x-text="job.customer_name"></p>
          <p class="text-[9px] uppercase text-brand-dark/40" x-text="job.location"></p>
          <p class="text-[9px] font-mono text-red-600 mt-1"
             x-show="job.slaRemaining">
             SLA: <span x-text="job.slaRemaining"></span>
          </p>
        </div>

        <!-- STATUS + ACTION -->
        <div class="flex flex-col items-end gap-2">

          <span
            class="text-[9px] font-black uppercase px-2 py-1 rounded-full"
            :class="
              job.status === 'assigned' ? 'bg-yellow-100 text-yellow-700' :
              job.status === 'in_progress' ? 'bg-blue-100 text-blue-700' :
              'bg-green-100 text-green-700'
            "
            x-text="job.status.replace('_',' ')"
          ></span>

          <button
            x-show="job.status === 'assigned'"
            @click="startJob(job.id)"
            class="px-5 py-2 bg-brand-olive text-white rounded-xl text-[10px] font-black uppercase">
            Start
          </button>

                    <button
                    x-show="job.status === 'in_progress'"
                    @click="completeJob(job)"
                    class="px-5 py-2 bg-green-600 text-white rounded-xl text-[10px] font-black uppercase">
                    Complete
                    </button>
            </button>
        </div>
      </div>
    </div>
  </template>

</section>

</main>

<!-- BOTTOM NAV -->
<nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-sm z-50">
  <div class="relative bg-white/90 backdrop-blur border rounded-full px-4 py-3 flex justify-between items-center shadow-2xl">

    <button class="w-12 h-12 text-brand-gold">
      <i class="fa-solid fa-house"></i>
    </button>

    <button @click="scrollToJobs()" class="w-12 h-12 text-brand-olive/40 hover:text-brand-gold">
      <i class="fa-solid fa-box-open"></i>
    </button>

    <div class="w-14 h-12"></div>

    <button onclick="window.location.href='completed_jobs.html'"
            class="w-12 h-12 text-brand-olive/40 hover:text-brand-gold">
      <i class="fa-solid fa-book-open"></i>
    </button>

    <button @click="logout()" class="w-12 h-12 text-brand-olive/40">
      <i class="fa-solid fa-circle-user"></i>
    </button>

    <button
      class="absolute left-1/2 -translate-x-1/2 -top-6
             w-14 h-14 bg-brand-gold rounded-full
             flex items-center justify-center text-white
             shadow-lg border-4 border-white">
      <i class="fa-solid fa-camera"></i>
    </button>

  </div>
</nav>

<!-- LOGIC -->
<script>
function dashboardHandler(){
   
return{
tech : null,
  techName:'',
  loading:true,
  jobs:[],
  stats:{activeJobs:0,earnings:0},
  timer:null,

  async init(){
    this.tech = JSON.parse(localStorage.getItem("active_tech"));
if(!this.tech){
  window.location.href = "partnerlogin.html";
  return;
}
this.techName = this.tech.name;

    await this.fetchJobs();
    this.startSLATimer();
    this.subscribeRealtime();
  },

  async fetchJobs(){
  this.loading = true;

  // 1. Active jobs (assigned + in_progress)
  const { data: activeJobs, error: activeError } = await window.sb
    .from("jobs")
    .select("*")
    .in("status", ["assigned", "in_progress"])
    .order("created_at", { ascending: false });

  if(activeError){
    console.error(activeError);
    this.loading = false;
    return;
  }

  this.jobs = activeJobs.map(j => ({
    ...j,
    slaRemaining: j.sla_deadline
      ? this.calcSLA(j.sla_deadline)
      : null
  }));
this.stats.activeJobs = this.jobs.length;

  // 2. Earnings from completed jobs
  const { data: completedJobs, error: completedError } = await window.sb
    .from("jobs")
    .select("technician_fee")
    .eq("status", "completed");

  if(completedError){
    console.error(completedError);
    this.stats.earnings = 0;
  } else {
    this.stats.earnings = completedJobs.reduce(
      (sum, j) => sum + (j.technician_fee || 0),
      0
    );
  }

  this.loading = false;
},


  startSLATimer(){
    this.timer = setInterval(() => {
      this.jobs = this.jobs.map(j => ({
        ...j,
        slaRemaining: j.sla_deadline
          ? this.calcSLA(j.sla_deadline)
          : null
      }));
    }, 1000);
  },

  calcSLA(deadline){
    const diff = new Date(deadline) - new Date();
    if(diff <= 0) return "BREACHED";
    const h = Math.floor(diff / 3600000);
    const m = Math.floor((diff % 3600000) / 60000);
    const s = Math.floor((diff % 60000) / 1000);
    return `${h}h ${m}m ${s}s`;
  },

  subscribeRealtime(){
  if(this.channel) return;

  this.channel = window.sb
    .channel('jobs-updates')
    .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'jobs' },
      () => this.fetchJobs()
    )
    .subscribe();
},

  async startJob(jobId){
  if(!this.tech) return;

  const { error } = await window.sb
    .from("jobs")
    .update({
      status: "in_progress",
      technician_id: this.tech.id
    })
    .eq("id", jobId);

  if(error){
    console.error(error);
    alert("Failed to start job");
    return;
  }

  await this.fetchJobs();
},

  scrollToJobs(){
    document.querySelector('#jobsSection')
      ?.scrollIntoView({behavior:'smooth'});
  },

  logout(){
    localStorage.removeItem("active_tech");
    window.location.href="partnerlogin.html";
  },
 async completeJob(job){
  const ok = confirm("Mark this job as completed?");
  if(!ok) return;

  const completedAt = new Date().toISOString();
  const fee = this.calculateFee({
    ...job,
    completed_at: completedAt
  });

  const { error } = await window.sb
    .from("jobs")
    .update({
      status: "completed",
      completed_at: completedAt,
      technician_fee: fee
    })
    .eq("id", job.id);

  if(error){
    alert("Failed to complete job");
    console.error(error);
    return;
  }

  await this.fetchJobs();
},

calculateFee(job){
  const BASE_FEES = {
    "AC Repair": 800,
    "Washing Machine": 600,
    "Refrigerator": 700,
    "RO Service": 500,
    "General": 400
  };

  let base = BASE_FEES[job.category] ?? 400;

  // SLA bonus
  if(job.sla_deadline){
    const breached = new Date(job.completed_at) > new Date(job.sla_deadline);
    if(breached){
      base = Math.round(base * 1.2); // +20%
    }
  }

  return base;
}

}
}
</script>

</body>
</html>
