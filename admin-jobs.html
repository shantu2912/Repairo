<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FixZen Admin | Booked Jobs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-[#f7f4ef]">

<div class="max-w-7xl mx-auto px-6 py-6 flex justify-between items-center">
  <h1 class="text-2xl font-black text-[#4b453a]">
    FIXZEN <span class="font-normal text-sm">Admin Â· Booked Jobs</span>
  </h1>
  <button onclick="loadJobs()" class="px-4 py-2 rounded-xl bg-[#4b453a] text-white text-sm font-bold">Refresh Dashboard</button>
</div>

<div class="max-w-7xl mx-auto bg-white rounded-3xl shadow overflow-hidden">
  <table class="w-full">
    <thead class="bg-gray-50 text-xs text-gray-500">
      <tr>
        <th class="p-4 text-left">SERVICE / PROFESSION</th>
        <th class="p-4 text-left">CUSTOMER</th>
        <th class="p-4">LOCATION</th>
        <th class="p-4">ASSIGNED TECH</th>
        <th class="p-4">STATUS</th>
        <th class="p-4">ACTION</th>
      </tr>
    </thead>
    <tbody id="jobList"></tbody>
  </table>
</div>

<script>
const sb = supabase.createClient(
  "https://kzxdxnxgouthsywbsnvl.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6eGR4bnhnb3V0aHN5d2JzbnZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMTczMzIsImV4cCI6MjA4MTg5MzMzMn0.nqzn89vmTFKVNuZPHfGRxdTg6UHT6GMud238rr49qag"
);

async function autoAssign(job) {
  // Logic: Match by exact Category, excluded already rejected techs
  const { data: techs } = await sb.from("technicians")
    .select("id")
    .eq("status", "approved")
    .eq("category", job.category)
    .not("id", "in", `(${ (job.rejected_by || []).join(',') })`)
    .order("jobs_done", { ascending: true })
    .limit(1);

  if (techs && techs.length > 0) {
    await sb.from("jobs").update({
      tech_id: techs[0].id,
      status: "assigned",
      assigned_at: new Date().toISOString()
    }).eq("id", job.id);
  }
}

async function loadJobs() {
  const { data: jobs } = await sb.from("jobs").select(`*, technicians(name)`);
  
  // Check for any unassigned pending jobs and trigger auto-assign
  for (const j of jobs) {
    if (j.status === "pending") await autoAssign(j);
  }

  // Refresh view
  const { data: updatedJobs } = await sb.from("jobs").select(`*, technicians(name)`).order("created_at", { ascending: false });
  const container = document.getElementById("jobList");
  container.innerHTML = "";

  updatedJobs.forEach(j => {
    container.innerHTML += `
      <tr class="border-t text-sm">
        <td class="p-4"><b>${j.category}</b><br><span class="text-xs text-gray-400">${j.device}</span></td>
        <td class="p-4">${j.customer_name}<br><span class="text-xs">${j.phone}</span></td>
        <td class="p-4 text-center">${j.location}</td>
        <td class="p-4 text-center font-bold ${j.tech_id ? 'text-blue-600' : 'text-red-400'}">
          ${j.technicians?.name || 'Searching Pro...'}
        </td>
        <td class="p-4 text-center">
          <span class="px-2 py-1 rounded-full text-[10px] font-bold bg-gray-100">${j.status.toUpperCase()}</span>
        </td>
        <td class="p-4 text-center">
           <button class="bg-[#4b453a] text-white px-3 py-1 rounded-lg text-xs">Manage</button>
        </td>
      </tr>`;
  });
}

// Initial load and background sync
loadJobs();
setInterval(loadJobs, 10000); 
</script>
</body>
</html>