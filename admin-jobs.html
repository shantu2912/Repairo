<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>FixZen Admin | Job Control Panel</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-[#f7f4ef]">

<!-- HEADER -->
<div class="max-w-7xl mx-auto px-6 py-6 flex justify-between items-center">
  <h1 class="text-2xl font-black text-[#4b453a]">
    FIXZEN <span class="font-normal text-sm">Admin · Job Control Panel</span>
  </h1>

  <button onclick="loadJobs()"
    class="px-4 py-2 rounded-xl bg-[#4b453a] text-white text-sm font-bold">
    Refresh
  </button>
</div>

<!-- TABLE -->
<div class="max-w-7xl mx-auto bg-white rounded-3xl shadow overflow-hidden">
  <table class="w-full">
    <thead class="bg-gray-50 text-xs text-gray-500">
      <tr>
        <th class="p-4 text-left">SERVICE</th>
        <th class="p-4 text-left">CUSTOMER</th>
        <th class="p-4">LOCATION</th>
        <th class="p-4">TECHNICIAN</th>
        <th class="p-4">STATUS</th>
        <th class="p-4">FEE</th>
        <th class="p-4">ACTIONS</th>
      </tr>
    </thead>
    <tbody id="jobList"></tbody>
  </table>
</div>

<!-- EDIT MODAL -->
<div id="editModal" class="hidden fixed inset-0 bg-black/50 items-center justify-center z-50">
  <div class="bg-white p-8 rounded-3xl w-[500px] shadow-2xl">
    <h2 class="text-xl font-black mb-6">Edit Job Details</h2>

    <input id="editName" class="w-full border p-3 rounded-lg mb-3" placeholder="Customer Name"/>
    <input id="editPhone" class="w-full border p-3 rounded-lg mb-3" placeholder="Phone"/>
    <input id="editLocation" class="w-full border p-3 rounded-lg mb-3" placeholder="Location"/>
    <input id="editFee" type="number" class="w-full border p-3 rounded-lg mb-3" placeholder="Technician Fee (₹)"/>
    <textarea id="editIssue" class="w-full border p-3 rounded-lg mb-3" placeholder="Issue"></textarea>
    <textarea id="editNotes" class="w-full border p-3 rounded-lg mb-4" placeholder="Admin Internal Notes"></textarea>

    <div class="flex gap-3">
      <button onclick="saveEdits()"
        class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold">
        Save Changes
      </button>
      <button onclick="closeEdit()"
        class="flex-1 border py-3 rounded-xl font-bold">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- ASSIGN MODAL -->
<div id="assignModal" class="hidden fixed inset-0 bg-black/50 items-center justify-center z-50">
  <div class="bg-white p-6 rounded-2xl w-[350px]">
    <h2 class="font-black mb-4">Assign / Reassign Technician</h2>
    <select id="techSelect" class="w-full border rounded-lg p-2 mb-4"></select>
    <div class="flex gap-2">
      <button onclick="confirmAssign()"
        class="flex-1 bg-[#b18b5e] text-white py-2 rounded-lg font-bold">
        Assign
      </button>
      <button onclick="closeAssign()"
        class="flex-1 border py-2 rounded-lg">
        Cancel
      </button>
    </div>
  </div>
</div>


<script>
window.sb = supabase.createClient(
  "https://kzxdxnxgouthsywbsnvl.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6eGR4bnhnb3V0aHN5d2JzbnZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMTczMzIsImV4cCI6MjA4MTg5MzMzMn0.nqzn89vmTFKVNuZPHfGRxdTg6UHT6GMud238rr49qag"
);
</script>
<script>

const jobList = document.getElementById("jobList");
let selectedJobId = null;
let editingJobId = null;

/* STATUS BADGE */
function badge(status){
  const map={
    pending:"bg-gray-100 text-gray-700",
    assigned:"bg-yellow-100 text-yellow-700",
    in_progress:"bg-blue-100 text-blue-700",
    completed:"bg-green-100 text-green-700",
    cancelled:"bg-red-100 text-red-700"
  };
  return `<span class="px-3 py-1 text-[10px] font-black rounded-full ${map[status]}">
    ${status.replace("_"," ").toUpperCase()}
  </span>`;
}

/* LOAD JOBS */
async function loadJobs(){
  const { data, error } = await supabase
    .from('jobs')
    .select(`
      id,
      category,
      device,
      issue,
      customer_name,
      phone,
      location,
      tech_id,
      technician_fee,
      status,
      created_at,
      technicians:technicians!jobs_tech_id_fkey (
        id,
        name,
        phone
      )
    `)
    .order('created_at', { ascending: false });

  if(error){
    console.error(error);
    alert(error.message);
    return;
  }

  jobList.innerHTML="";

  data.forEach(j=>{
    jobList.innerHTML+=`
    <tr class="border-t">
      <td class="p-4">
        <p class="font-bold">${j.category}</p>
        <p class="text-xs text-gray-500">${j.device}</p>
        <p class="text-xs">${j.issue}</p>
      </td>

      <td class="p-4">
        <p class="font-semibold">${j.customer_name}</p>
        <p class="text-xs text-gray-500">${j.phone ?? "-"}</p>
      </td>

      <td class="p-4">${j.location ?? "-"}</td>

      <td class="p-4 font-bold ${j.tech_id ? 'text-green-700':'text-red-600'}">
        ${j.tech_id ? (j.technicians?.name ?? "Assigned") : "Unassigned"}
      </td>

      <td class="p-4 text-center">${badge(j.status)}</td>

      <td class="p-4 text-center font-bold">₹${j.technician_fee ?? 0}</td>

      <td class="p-4">
        <div class="flex flex-wrap gap-2">
          <button onclick="openAssign('${j.id}','${j.category}')"
            class="px-3 py-2 text-xs font-bold bg-yellow-500 text-white rounded-lg">
            ${j.tech_id ? "REASSIGN":"ASSIGN"}
          </button>

          <button onclick="openEdit('${j.id}', ${encodeURIComponent(JSON.stringify(j))})"
            class="px-3 py-2 text-xs font-bold bg-blue-600 text-white rounded-lg">
            EDIT
          </button>

          <button onclick="forceComplete('${j.id}')"
            class="px-3 py-2 text-xs font-bold bg-green-600 text-white rounded-lg">
            COMPLETE
          </button>

          <button onclick="cancelJob('${j.id}')"
            class="px-3 py-2 text-xs font-bold bg-red-600 text-white rounded-lg">
            CANCEL
          </button>
        </div>
      </td>
    </tr>`;
  });
}


/* EDIT JOB */
window.openEdit=(id,jobRaw)=>{
  const job=JSON.parse(decodeURIComponent(jobRaw));
  editingJobId=id;
  document.getElementById("editName").value=job.customer_name||"";
  document.getElementById("editPhone").value=job.phone||"";
  document.getElementById("editLocation").value=job.location||"";
  document.getElementById("editFee").value=job.technician_fee||0;
  document.getElementById("editIssue").value=job.issue||"";
  document.getElementById("editNotes").value=job.admin_notes||"";
  document.getElementById("editModal").classList.remove("hidden");
  document.getElementById("editModal").classList.add("flex");
};

window.closeEdit=()=>{
  document.getElementById("editModal").classList.add("hidden");
  editingJobId=null;
};

window.saveEdits=async()=>{
  const updates={
    customer_name:document.getElementById("editName").value,
    phone:document.getElementById("editPhone").value,
    location:document.getElementById("editLocation").value,
    technician_fee:Number(document.getElementById("editFee").value),
    issue:document.getElementById("editIssue").value,
    admin_notes:document.getElementById("editNotes").value
  };

  const {error}=await sb.from("jobs").update(updates).eq("id",editingJobId);
  if(error){alert(error.message);return;}
  closeEdit();
  loadJobs();
};

/* ASSIGN TECH */
window.openAssign=async(jobId,category)=>{
  selectedJobId=jobId;
  const select=document.getElementById("techSelect");
  select.innerHTML="Loading...";

  const {data}=await sb
    .from("technicians")
    .select("id,name,category,experience")
    .eq("status","approved")
    .ilike("category",category);

  select.innerHTML="";
  data.forEach(t=>{
    select.innerHTML+=`<option value="${t.id}">
      ${t.name} | ${t.experience} yrs
    </option>`;
  });

  document.getElementById("assignModal").classList.remove("hidden");
  document.getElementById("assignModal").classList.add("flex");
};

window.confirmAssign=async()=>{
  const techId=document.getElementById("techSelect").value;
  await sb.from("jobs").update({
    tech_id:techId,
    status:"assigned"
  }).eq("id",selectedJobId);

  closeAssign();
  loadJobs();
};

window.closeAssign=()=>{
  document.getElementById("assignModal").classList.add("hidden");
};

/* FORCE COMPLETE */
window.forceComplete=async(id)=>{
  if(!confirm("Force mark as completed?")) return;
  await sb.from("jobs").update({status:"completed"}).eq("id",id);
  loadJobs();
};

/* CANCEL JOB */
window.cancelJob=async(id)=>{
  if(!confirm("Cancel this job?")) return;
  await sb.from("jobs").update({
    status:"cancelled",
    tech_id:null
  }).eq("id",id);
  loadJobs();
};

loadJobs();
</script>

</body>
</html>
